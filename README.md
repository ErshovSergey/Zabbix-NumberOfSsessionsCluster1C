# Мониторинг количества сессий в кластере 1С с использованием запросов к серверу администрирования 1С (RAS/RAC).
Проверено на Windows/1C:8.3.
Возможно будет работать на Linux.

Шаблон определяет UUID кластера 1С, автоматически обнаруживает БД в кластере 1С и строит графики количества сессий в каждой БД.
Также мониторится количество сессий с ненулевым параметром memory-current - косвенно позволяет оценить загруженность кластера. Пороги триггеров задаются макросами.

Мониторинг происходит через запуск утилиты удаленного управления rac.exe агентом zabbix.

Необходимо проверить макросы в шаблоне, если данные не верны - переопределить макросы на уровне хоста:
- {$RAC.EXE} - путь к утилите на сервере. Версия утилиты должны соответствовать службы ras.exe, версия которой должно соответствовать версии сервера 1С.
- {$HOST} и {$PORT} - адрес хоста и порт на котором работает утилита.

## Построение графиков количества сессий во всех базах кластера 1С-Предпрятие v.8.3.  
Количество сессий в базе 1С-Кластер можно получить с помощью службы сервера удаленного администрирования RAS(Remote Administration Server).  
Доступ к RAS можно получить с помощью RAC(Remote Administration Client).  
Т.о. через zabbix агент можно получать данные из кластера 1С  
    Zabbixagent<-->RAC<-->RAS<-->Cluster1C.  
Файл для агента [cluster1-base-session.conf](./cluster1-base-session.conf) - разместить в папке ```<FolderZabbixAgent>\zabbix_agentd.conf.d\```.  
Файл [шаблона](./Zabbix-NumberOfSsessionsCluster1C.yaml) для Zabbix (проверено в версии 5.2).  
Список баз 1С на кластере получается автообнаружением.  
Кроме количества сессий получается количество пользователей с ненулевым показателем  *"memory-current"* - это косвенно показывает нагрузку на кластер и возможные проблемы у пользователей. Триггеры оповещают о проблемах.  
  
### Необходимые условия  
- Версии RAC, RAS и кластера должны быть одинаковы.  
- Брендмауер не должен мешать доступу  
### Порядок работ  
#### Запустить службу сервер удаленного администрирования RAS  
Установка службы  
```
sc create "1C:Enterprise RAS" binpath= "C:\Program Files\1cv8\Х.Х.Х.ХХХХ\bin\ras.exe cluster --service" displayname= "1C:Enterprise RAS" start= auto
net start "1C:Enterprise RAS"
```
#### Проверить доступ утилитой RAC  
На узле с RAS запустить  
```"c:\Program Files\1cv8\8.3.XXX.XXX\bin\rac.exe" cluster list```  
результат должен быть примерно таким  
```cluster                       : d555dcae-XXX-XXXX-XXXX-XXXXXXXXXX```  
#### Добавить в zabbixagent файл с пользовательскими скриптами  
- положить файл [cluster1-base-session.conf](./cluster1-base-session.conf) в <Path_to_ZabbixAgent>\zabbix_agentd.conf.d\  
- перезапустить zabbixagent  
#### Проверить работу агента zabbix командой с Zabbix сервера(адрес и порт заменить своими)  
```zabbix_get -s XX.XX.XXX.XXX -p 10050 -k CLUSTER1C.UUID["c:\Program Files\1cv8\8.3.XXX.XXX\bin\rac.exe","localhost","1545"]```  
результат должен быть примерно таким  
```cluster                       : d555dcae-XXX-XXXX-XXXX-XXXXXXXXXX```  
#### Добавить и настроить шаблон  
- к узлу кластера 1С в Zabbix добавить шаблон  
- проверить путь до RAC - макросы {$HOST}, {$PORT}, {$RAC.EXE}, если не совпадет на уровне шаблона - исправить на уровне узла  
- дождаться получения UUID кластера - смотреть в данных  
- заполнить макрос {$CLUSTER1C.UUID}, если нет такого макроса - добавить макрос к узлу  
### To-Do  
- вероятно всё это заработает на \*NIX системах при правильном указании в макросе пути до RAC - требуется проверить  
- добавить проверку последнего входа "живого" пользователя в БД для отслеживания брошенных БД

  
